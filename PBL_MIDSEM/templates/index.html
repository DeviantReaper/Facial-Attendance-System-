<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>NEURO-SCAN v3.0 · Attendance</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:#04060f; --surface:#080d1c; --panel:#0c1428; --border:#0ff3;
      --cyan:#00ffe5; --cyan-dim:#00ffe540; --magenta:#ff2d78; --yellow:#f5e642;
      --green:#39ff14; --red:#ff3860; --text:#c8faf4; --text-dim:#4a8a80;
      --glow-c:0 0 8px #00ffe5,0 0 20px #00ffe540;
      --glow-m:0 0 8px #ff2d78,0 0 20px #ff2d7840;
      --glow-r:0 0 8px #ff3860,0 0 20px #ff386040;
      --font-hud:'Share Tech Mono',monospace;
      --font-ui:'Orbitron',sans-serif;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font-hud);overflow:hidden}
    body::before{content:'';position:fixed;inset:0;z-index:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,255,229,.016) 2px,rgba(0,255,229,.016) 4px);pointer-events:none;animation:scanlines 8s linear infinite}
    @keyframes scanlines{from{background-position:0 0}to{background-position:0 200px}}
    body::after{content:'';position:fixed;inset:0;z-index:0;background:radial-gradient(ellipse at center,transparent 55%,#000b 100%);pointer-events:none}

    #app{position:relative;z-index:1;display:grid;grid-template-rows:60px 1fr 44px;grid-template-columns:1fr 360px;height:100vh}

    /* Header */
    #header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:0 24px;background:linear-gradient(90deg,#030810,#06112a 50%,#030810);border-bottom:1px solid var(--border);box-shadow:0 0 30px #00ffe518}
    .logo{font-family:var(--font-ui);font-weight:900;font-size:1.3rem;letter-spacing:.15em;color:var(--cyan);text-shadow:var(--glow-c);animation:flicker 7s infinite}
    .logo span{color:var(--magenta);text-shadow:var(--glow-m)}
    @keyframes flicker{0%,100%{opacity:1}92%{opacity:1}93%{opacity:.4}94%{opacity:1}96%{opacity:.6}97%{opacity:1}}
    .hdr-right{display:flex;align-items:center;gap:20px;font-size:.68rem;color:var(--text-dim);letter-spacing:.08em}
    .live-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green);animation:pdot 1.2s ease-in-out infinite}
    @keyframes pdot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.7)}}
    .hdr-btn{font-family:var(--font-hud);font-size:.62rem;letter-spacing:.12em;padding:5px 14px;border-radius:2px;cursor:pointer;border:1px solid;transition:all .2s}
    .hdr-btn.enroll{color:var(--cyan);border-color:var(--cyan);background:transparent}.hdr-btn.enroll:hover{background:var(--cyan);color:#000;box-shadow:var(--glow-c)}
    .hdr-btn.export{color:var(--green);border-color:var(--green);background:transparent}.hdr-btn.export:hover{background:var(--green);color:#000;box-shadow:0 0 12px var(--green)}

    /* Video column */
    #video-col{grid-column:1;display:flex;flex-direction:column;padding:14px 12px 12px 18px;gap:12px}
    .video-wrapper{position:relative;flex:1;border:1px solid var(--border);border-radius:4px;overflow:hidden;background:#000;box-shadow:0 0 40px #00ffe512,inset 0 0 60px #000}
    #cam-feed{width:100%;height:100%;object-fit:cover;display:block}
    .video-wrapper::before,.video-wrapper::after{content:'';position:absolute;width:28px;height:28px;border-color:var(--cyan);border-style:solid;z-index:4}
    .video-wrapper::before{top:0;left:0;border-width:2px 0 0 2px;box-shadow:-2px -2px 10px var(--cyan-dim)}
    .video-wrapper::after{bottom:0;right:0;border-width:0 2px 2px 0;box-shadow:2px 2px 10px var(--cyan-dim)}

    .scan-overlay{position:absolute;inset:0;z-index:3;pointer-events:none;opacity:0;transition:opacity .3s}
    .scan-overlay.active{opacity:1}
    .scan-overlay::before{content:'';position:absolute;left:0;right:0;height:3px;background:linear-gradient(90deg,transparent,var(--cyan) 30%,#fff 50%,var(--cyan) 70%,transparent);box-shadow:var(--glow-c);animation:sweep 1.4s ease-in-out infinite}
    @keyframes sweep{from{top:0}to{top:100%}}

    .recog-badge{position:absolute;top:56px;left:50%;transform:translateX(-50%);z-index:5;font-family:var(--font-ui);font-size:.8rem;letter-spacing:.2em;color:#000;background:var(--cyan);padding:4px 20px;border-radius:2px;box-shadow:var(--glow-c);opacity:0;transition:opacity .25s;pointer-events:none}
    .recog-badge.show{opacity:1}

    /* Unknown alert overlay */
    .unknown-overlay{position:absolute;inset:0;z-index:6;pointer-events:none;opacity:0;transition:opacity .4s;border:3px solid var(--red);box-shadow:inset 0 0 60px #ff386030}
    .unknown-overlay.active{opacity:1;animation:red-pulse 0.8s ease-in-out infinite}
    @keyframes red-pulse{0%,100%{border-color:#ff3860;box-shadow:inset 0 0 60px #ff386030}50%{border-color:#ff7096;box-shadow:inset 0 0 80px #ff386055}}
    .unknown-badge{position:absolute;top:56px;left:50%;transform:translateX(-50%);z-index:7;font-family:var(--font-ui);font-size:.8rem;letter-spacing:.18em;color:#fff;background:var(--red);padding:4px 18px;border-radius:2px;box-shadow:var(--glow-r);opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap}
    .unknown-badge.show{opacity:1}

    .bottom-bar{display:flex;align-items:center;gap:14px;font-size:.68rem;color:var(--text-dim);letter-spacing:.1em}
    .fval{font-family:var(--font-ui);font-size:1.2rem;color:var(--cyan);text-shadow:var(--glow-c);min-width:24px}
    .gauge-bar{flex:1;max-width:200px;height:4px;background:#0ff1;border-radius:2px;overflow:hidden}
    .gauge-fill{height:100%;background:linear-gradient(90deg,var(--cyan),var(--magenta));border-radius:2px;width:0%;transition:width .6s}

    /* Right panel */
    #right-col{grid-column:2;display:flex;flex-direction:column;padding:14px 18px 12px 12px;gap:12px;border-left:1px solid var(--border);overflow:hidden}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:3px;padding:12px 14px}
    .panel-title{font-family:var(--font-ui);font-size:.58rem;letter-spacing:.22em;color:var(--cyan);text-shadow:var(--glow-c);margin-bottom:10px;padding-bottom:7px;border-bottom:1px solid #0ff2;display:flex;align-items:center;gap:7px}

    /* Stats */
    .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .stat-card{background:var(--surface);border:1px solid #0ff1;border-radius:3px;padding:8px 10px;transition:border-color .3s}
    .stat-card:hover{border-color:var(--cyan);box-shadow:0 0 10px var(--cyan-dim)}
    .stat-card .lbl{font-size:.52rem;letter-spacing:.1em;color:var(--text-dim);margin-bottom:3px}
    .stat-card .num{font-family:var(--font-ui);font-size:1.4rem;line-height:1}
    .num.cy{color:var(--cyan);text-shadow:var(--glow-c)}
    .num.mg{color:var(--magenta);text-shadow:var(--glow-m)}
    .num.gn{color:var(--green);text-shadow:0 0 8px var(--green)}
    .num.rd{color:var(--red);text-shadow:var(--glow-r)}

    /* Chart */
    .chart-wrap{position:relative;height:130px;display:flex;align-items:center;justify-content:center;gap:20px}
    .chart-wrap canvas{max-height:130px !important}
    .chart-legend{font-size:.6rem;letter-spacing:.08em;color:var(--text-dim);display:flex;flex-direction:column;gap:6px}
    .legend-item{display:flex;align-items:center;gap:6px}
    .legend-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

    /* Buttons row */
    .btn-row{display:flex;gap:8px;margin-top:8px}
    .btn{flex:1;padding:7px;font-family:var(--font-hud);font-size:.6rem;letter-spacing:.12em;border-radius:2px;cursor:pointer;border:1px solid;transition:all .2s;text-align:center}
    .btn-red{color:var(--magenta);border-color:var(--magenta);background:transparent}.btn-red:hover{background:var(--magenta);color:#000;box-shadow:var(--glow-m)}
    .btn-green{color:var(--green);border-color:var(--green);background:transparent}.btn-green:hover{background:var(--green);color:#000}

    /* Alert log */
    .alert-strip{background:#ff38601a;border:1px solid #ff386040;border-radius:2px;padding:6px 10px;font-size:.62rem;color:var(--red);letter-spacing:.08em;display:none}
    .alert-strip.show{display:block;animation:blink-border .6s ease-in-out 3}
    @keyframes blink-border{0%,100%{border-color:#ff386040}50%{border-color:var(--red)}}

    /* Attendance log */
    #log-outer{flex:1;display:flex;flex-direction:column;overflow:hidden}
    #log-container{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#0ff3 transparent}
    #log-container::-webkit-scrollbar{width:4px}
    #log-container::-webkit-scrollbar-thumb{background:#0ff3;border-radius:2px}
    .log-entry{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:7px;padding:7px 0;border-bottom:1px solid #0ff1;animation:slide-in .3s ease;font-size:.65rem}
    @keyframes slide-in{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:translateX(0)}}
    .log-av{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--cyan-dim),#ff2d7830);border:1px solid var(--cyan);display:flex;align-items:center;justify-content:center;font-family:var(--font-ui);font-size:.48rem;color:var(--cyan);flex-shrink:0}
    .log-id{color:var(--text);letter-spacing:.05em;font-size:.66rem}
    .log-ts{color:var(--text-dim);font-size:.58rem}
    .log-badge{font-size:.5rem;letter-spacing:.1em;color:var(--green);background:#39ff1415;border:1px solid #39ff1440;border-radius:2px;padding:2px 5px;white-space:nowrap}
    .empty-log{text-align:center;padding:24px 0;color:var(--text-dim);font-size:.65rem;letter-spacing:.1em}
    .empty-icon{font-size:1.8rem;margin-bottom:6px;opacity:.3}

    /* Statusbar */
    #statusbar{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:0 20px;background:#030810;border-top:1px solid var(--border);font-size:.6rem;letter-spacing:.08em;color:var(--text-dim)}
    #status-msg{color:var(--cyan);transition:color .3s}
  </style>
</head>
<body>
<div id="app">

  <!-- Header -->
  <header id="header">
    <div class="logo">NEURO<span>·</span>SCAN <span style="font-size:.7rem;color:var(--text-dim)">v3.0</span></div>
    <div class="hdr-right">
      <span><span class="live-dot"></span>&nbsp;LIVE</span>
      <span id="hdr-time">--:--:--</span>
      <button class="hdr-btn enroll" onclick="window.location='/enroll'">+ ENROLL</button>
      <button class="hdr-btn export" onclick="window.location='/api/export'">↓ CSV</button>
    </div>
  </header>

  <!-- Video -->
  <section id="video-col">
    <div class="video-wrapper">
      <img id="cam-feed" src="/video_feed" alt="Camera Feed"/>
      <div class="scan-overlay" id="scan-overlay"></div>
      <div class="unknown-overlay" id="unknown-overlay"></div>
      <div class="recog-badge" id="recog-badge">▶ STUDENT RECOGNIZED</div>
      <div class="unknown-badge" id="unknown-badge">⚠ UNIDENTIFIED PERSON</div>
    </div>
    <div class="bottom-bar">
      <span>FACES</span>
      <span class="fval" id="face-val">0</span>
      <div class="gauge-bar"><div class="gauge-fill" id="face-gauge"></div></div>
      <span id="status-text" style="color:var(--text-dim);font-size:.62rem;letter-spacing:.1em">STANDBY</span>
    </div>
  </section>

  <!-- Right panel -->
  <aside id="right-col">

    <!-- Stats + Chart -->
    <div class="panel">
      <div class="panel-title">
        <svg width="11" height="11" viewBox="0 0 12 12" fill="none"><rect x="1" y="5" width="2" height="6" fill="#00ffe5"/><rect x="5" y="2" width="2" height="9" fill="#00ffe5"/><rect x="9" y="0" width="2" height="11" fill="#ff2d78"/></svg>
        SESSION METRICS
      </div>
      <div class="stats-grid">
        <div class="stat-card"><div class="lbl">PRESENT</div><div class="num gn" id="s-present">0</div></div>
        <div class="stat-card"><div class="lbl">ABSENT</div><div class="num rd" id="s-absent">0</div></div>
        <div class="stat-card"><div class="lbl">ENROLLED</div><div class="num cy" id="s-enrolled">0</div></div>
      </div>

      <!-- Donut chart -->
      <div class="chart-wrap" style="margin-top:10px">
        <canvas id="donut-chart" width="120" height="120"></canvas>
        <div class="chart-legend">
          <div class="legend-item"><div class="legend-dot" style="background:#39ff14"></div><span id="leg-present">Present: 0</span></div>
          <div class="legend-item"><div class="legend-dot" style="background:#ff3860"></div><span id="leg-absent">Absent: 0</span></div>
          <div class="legend-item"><div class="legend-dot" style="background:#00ffe5"></div><span id="leg-faces">Faces now: 0</span></div>
        </div>
      </div>

      <!-- Unknown alert strip -->
      <div class="alert-strip" id="alert-strip">⚠ &nbsp;UNIDENTIFIED FACE DETECTED</div>

      <!-- Action buttons -->
      <div class="btn-row">
        <div class="btn btn-green" onclick="window.location='/api/export'">↓ EXPORT CSV</div>
        <div class="btn btn-red" onclick="resetSession()">⟳ RESET</div>
      </div>
    </div>

    <!-- Attendance log -->
    <div id="log-outer" class="panel">
      <div class="panel-title">
        <svg width="11" height="11" viewBox="0 0 12 12" fill="none"><circle cx="6" cy="6" r="5" stroke="#00ffe5" stroke-width="1.5"/><path d="M6 3v3l2 2" stroke="#00ffe5" stroke-width="1.5" stroke-linecap="round"/></svg>
        ATTENDANCE LOG
      </div>
      <div id="log-container">
        <div class="empty-log" id="empty-msg">
          <div class="empty-icon">◉</div>
          AWAITING DETECTION…
        </div>
      </div>
    </div>

  </aside>

  <!-- Status bar -->
  <footer id="statusbar">
    <span id="status-msg">INITIALIZING…</span>
    <span>NEURO-SCAN v3.0 · MEDIAPIPE · FLASK</span>
    <span>SESSION&nbsp;<span id="s-elapsed">00:00</span></span>
  </footer>

</div><!-- #app -->

<script>
  const synth = window.speechSynthesis;
  function speak(t){ if(!synth) return; synth.cancel(); const u=new SpeechSynthesisUtterance(t); u.rate=0.9;u.pitch=0.75;u.volume=0.85; synth.speak(u); }

  // Clock
  function tick(){
    const n=new Date();
    document.getElementById("hdr-time").textContent=n.toTimeString().slice(0,8);
  }
  setInterval(tick,1000); tick();

  // Chart
  const ctx = document.getElementById("donut-chart").getContext("2d");
  const donut = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels:["Present","Absent","Active Faces"],
      datasets:[{ data:[0,1,0],
        backgroundColor:["#39ff14","#ff3860","#00ffe5"],
        borderColor:["#39ff1450","#ff386050","#00ffe550"],
        borderWidth:1, hoverOffset:4 }]
    },
    options:{
      responsive:false, cutout:"72%",
      plugins:{ legend:{display:false}, tooltip:{
        callbacks:{ label: ctx => ` ${ctx.label}: ${ctx.parsed}` }
      }},
      animation:{ duration:600 }
    }
  });

  const renderedIds = new Set();
  let frameCount=0, lastFPS=performance.now();

  async function poll(){
    try{
      const r = await fetch("/api/status");
      const d = await r.json();

      // Stats
      document.getElementById("s-present").textContent  = d.total_present;
      document.getElementById("s-absent").textContent   = d.total_absent;
      document.getElementById("s-enrolled").textContent = d.total_enrolled;
      document.getElementById("s-elapsed").textContent  = d.elapsed;
      document.getElementById("face-val").textContent   = d.face_count;
      document.getElementById("face-gauge").style.width = Math.min(100,d.face_count*20)+"%";

      // Chart
      donut.data.datasets[0].data = [d.total_present, d.total_absent, d.face_count];
      donut.update("none");
      document.getElementById("leg-present").textContent = `Present: ${d.total_present}`;
      document.getElementById("leg-absent").textContent  = `Absent: ${d.total_absent}`;
      document.getElementById("leg-faces").textContent   = `Faces now: ${d.face_count}`;

      // Status
      const stEl  = document.getElementById("status-text");
      const stMsg = document.getElementById("status-msg");
      if(d.face_count>0){
        stEl.textContent="DETECTING"; stEl.style.color="var(--cyan)";
        stMsg.textContent=`FACE LOCK — ${d.face_count} TARGET(S) · ${d.total_present}/${d.total_enrolled} MARKED`;
      } else {
        stEl.textContent="STANDBY"; stEl.style.color="var(--text-dim)";
        stMsg.textContent="SCANNING ENVIRONMENT…";
      }

      // Scan overlay + badge
      document.getElementById("scan-overlay").classList.toggle("active", d.scan_active);
      document.getElementById("recog-badge").classList.toggle("show", d.scan_active);

      // Unknown alert
      const isUnknown = d.unknown_active;
      document.getElementById("unknown-overlay").classList.toggle("active", isUnknown);
      document.getElementById("unknown-badge").classList.toggle("show", isUnknown);
      const alertStrip = document.getElementById("alert-strip");
      if(isUnknown){
        alertStrip.classList.add("show");
        alertStrip.textContent = `⚠  UNIDENTIFIED FACE — ${new Date().toTimeString().slice(0,8)}`;
      } else {
        alertStrip.classList.remove("show");
      }

      // Voice
      if(d.announcement){ speak(d.announcement); }

      // Log entries
      const container = document.getElementById("log-container");
      const empty     = document.getElementById("empty-msg");
      d.log.forEach(item => {
        if(!renderedIds.has(item.id)){
          renderedIds.add(item.id);
          if(empty) empty.remove();
          const initials = item.id.split(" ").map(w=>w[0]).join("").toUpperCase().slice(0,3);
          const el = document.createElement("div");
          el.className = "log-entry";
          el.innerHTML = `
            <div class="log-av">${initials}</div>
            <div><div class="log-id">${item.id}</div><div class="log-ts">${item.time} · ${item.confidence}</div></div>
            <div class="log-badge">${item.status}</div>`;
          container.insertBefore(el, container.firstChild);
        }
      });

      // FPS
      frameCount++;
      if(performance.now()-lastFPS>=1000){
        lastFPS=performance.now(); frameCount=0;
      }
    } catch(e){
      document.getElementById("status-msg").textContent="CONNECTION ERROR — is app.py running?";
    }
  }

  async function resetSession(){
    await fetch("/api/reset",{method:"POST"});
    renderedIds.clear();
    document.getElementById("log-container").innerHTML =
      '<div class="empty-log" id="empty-msg"><div class="empty-icon">◉</div>SESSION RESET…</div>';
    speak("Session reset");
  }

  document.getElementById("status-msg").textContent="SYSTEM ONLINE";
  setInterval(poll,600);
  poll();
</script>
</body>
</html>